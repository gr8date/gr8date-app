{% extends 'website/synergy_base_header.html' %}
{% load static %}

{% block content %}
<style>
  :root {
    --brand: #cdad7c;
    --brand-dark: #a88a5a;
    --brand-soft: #e7d3af;
    --bg: #050509;
    --bg-soft: #090b12;
    --bg-elevated: #0b0e18;
    --card: rgba(15, 23, 42, 0.96);
    --card-soft: rgba(15, 23, 42, 0.9);
    --text: #f9fafb;
    --text-soft: #9ca3af;
    --text-muted: #6b7280;
    --text-gold: #f5e6c5;
    --border: rgba(148, 163, 184, 0.45);
    --border-soft: rgba(148, 163, 184, 0.2);
    --shadow-soft: 0 20px 60px rgba(15, 23, 42, 0.9);
    --shadow-strong: 0 30px 80px rgba(0, 0, 0, 0.95);
    --radius: 20px;
  }

  .message-detail-container {
    margin-top: 100px;
    padding: 1.5rem;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
    height: calc(100vh - 140px);
    display: flex;
    flex-direction: column;
  }

  .message-header {
    display: flex;
    align-items: center;
    padding: 1rem 0;
    border-bottom: 1px solid var(--border);
    margin-bottom: 1rem;
    position: sticky;
    top: 0;
    background: var(--bg);
    z-index: 10;
  }

  .back-button {
    background: none;
    border: none;
    color: var(--text);
    font-size: 1.5rem;
    cursor: pointer;
    margin-right: 1rem;
    padding: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .message-profile {
    display: flex;
    align-items: center;
    flex: 1;
  }

  .message-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 1rem;
    border: 2px solid var(--brand-soft);
  }

  .message-profile-info h2 {
    margin: 0;
    font-size: 1.2rem;
    color: var(--text);
  }

  .message-profile-info p {
    margin: 0;
    font-size: 0.9rem;
    color: var(--text-soft);
  }

  /* Messages Area - FIXED: Add padding for input area */
  .messages-area {
    flex: 1;
    overflow-y: auto;
    padding: 1rem 0;
    padding-bottom: 80px; /* Added padding to see last messages above input */
    display: flex;
    flex-direction: column;
    gap: 1rem;
    min-height: 0;
  }

  .message-bubble {
    max-width: 70%;
    padding: 0.8rem 1.2rem;
    border-radius: 20px;
    position: relative;
    word-wrap: break-word;
  }

  .message-own {
    align-self: flex-end;
    background: linear-gradient(135deg, var(--brand), var(--brand-dark));
    color: #000;
    border-bottom-right-radius: 5px;
  }

  .message-other {
    align-self: flex-start;
    background: var(--card-soft);
    color: var(--text);
    border: 1px solid var(--border);
    border-bottom-left-radius: 5px;
  }

  .message-text {
    margin: 0;
    line-height: 1.4;
  }

  .message-time {
    font-size: 0.7rem;
    margin-top: 0.3rem;
    opacity: 0.7;
    text-align: right;
  }

  /* Message Delete Actions */
  .message-actions {
    position: absolute;
    top: 5px;
    right: 10px;
    display: flex;
    gap: 5px;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .message-bubble:hover .message-actions {
    opacity: 1;
  }

  .delete-message-btn {
    background: none;
    border: none;
    color: var(--text-soft);
    cursor: pointer;
    font-size: 12px;
    padding: 2px 5px;
    border-radius: 3px;
  }

  .delete-message-btn:hover {
    color: #ff6b6b;
    background: rgba(255, 107, 107, 0.1);
  }

  /* Message Input - FIXED: Make sticky */
  .message-input-area {
    display: flex;
    gap: 1rem;
    padding: 1rem 0;
    border-top: 1px solid var(--border);
    align-items: center;
    background: var(--bg);
    position: sticky; /* Changed to sticky */
    bottom: 0;
    flex-shrink: 0;
    z-index: 10; /* Ensure it stays above messages */
  }

  .message-input {
    flex: 1;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 25px;
    padding: 0.8rem 1.2rem;
    color: var(--text);
    font-size: 0.9rem;
    resize: none;
    outline: none;
    height: 50px;
    max-height: 120px;
  }

  .message-input:focus {
    border-color: var(--brand);
  }

  .send-button {
    background: linear-gradient(135deg, var(--brand), var(--brand-dark));
    color: #000;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .send-button:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(205, 173, 119, 0.3);
  }

  .send-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  .send-button svg {
    width: 20px;
    height: 20px;
  }

  /* Empty State */
  .no-messages {
    text-align: center;
    padding: 2rem;
    color: var(--text-soft);
    font-style: italic;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .message-detail-container {
      padding: 1rem;
      margin-top: 80px;
      height: calc(100vh - 120px);
    }

    .message-bubble {
      max-width: 85%;
    }

    .message-input-area {
      gap: 0.5rem;
    }

    .message-input {
      padding: 0.8rem 1rem;
    }
  }

  @media (max-width: 480px) {
    .message-detail-container {
      padding: 0.8rem;
      margin-top: 70px;
      height: calc(100vh - 110px);
    }

    .message-avatar {
      width: 40px;
      height: 40px;
    }

    .message-profile-info h2 {
      font-size: 1rem;
    }

    .message-bubble {
      max-width: 90%;
      padding: 0.6rem 1rem;
    }
  }
</style>

<div class="message-detail-container">
  <!-- Header -->
  <div class="message-header">
    <button class="back-button" onclick="window.history.back()">‹</button>
    <div class="message-profile">
      <img src="{{ profile.profile_image|default:'/static/images/default-profile.jpg' }}" 
           alt="{{ profile.profile_name|default:'User' }}" 
           class="message-avatar"
           onerror="this.src='{% static 'images/default-profile.jpg' %}'">
      <div class="message-profile-info">
        <h2>{{ profile.profile_name|default:'User' }}</h2>
        <p>{{ profile.age|default:'' }} • {{ profile.location|default:'' }}</p>
      </div>
    </div>
  </div>

  <!-- Messages -->
  <div class="messages-area" id="messagesArea">
    {% for message in messages %}
    <div class="message-bubble {% if message.sender.id == user.id %}message-own{% else %}message-other{% endif %}"
         data-message-id="{{ message.id }}">
      <div class="message-actions">
        {% if message.sender.id == user.id %}
          <button class="delete-message-btn" onclick="deleteMessage('{{ message.id }}')" 
                  title="Delete message">✕</button>
        {% endif %}
      </div>
      <p class="message-text">{{ message.content }}</p>
      <div class="message-time">{{ message.created_at|date:"g:i A" }}</div>
    </div>
    {% empty %}
    <div class="no-messages">
      <p>No messages yet. Start the conversation!</p>
    </div>
    {% endfor %}
  </div>

  <!-- Input Area -->
  <div class="message-input-area">
    <textarea 
      class="message-input" 
      placeholder="Type a message..." 
      id="messageInput"
      rows="1"
    ></textarea>
    <button class="send-button" id="sendButton">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22,2 15,22 11,13 2,9"></polygon>
      </svg>
    </button>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const messagesArea = document.getElementById('messagesArea');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const otherUserId = {{ profile.user_id|default:0 }};

    console.log('Message Detail Loaded');
    console.log('Other user ID:', otherUserId);
    console.log('CSRF Token:', '{{ csrf_token }}');

    // Auto-scroll to bottom of messages
    function scrollToBottom() {
      if (messagesArea) {
        messagesArea.scrollTop = messagesArea.scrollHeight;
      }
    }

    // Auto-resize textarea
    function autoResizeTextarea() {
      if (messageInput) {
        messageInput.style.height = 'auto';
        const newHeight = Math.min(messageInput.scrollHeight, 120);
        messageInput.style.height = newHeight + 'px';
      }
    }

    // Add message to UI
    function addMessageToUI(message, isOwn = true) {
      if (!messagesArea) return;
      
      const messageBubble = document.createElement('div');
      messageBubble.className = `message-bubble ${isOwn ? 'message-own' : 'message-other'}`;
      
      if (message.id) {
        messageBubble.setAttribute('data-message-id', message.id);
      }
      
      // Add delete button for own messages
      const deleteButton = isOwn ? 
        `<div class="message-actions">
          <button class="delete-message-btn" onclick="deleteMessage('${message.id || 'temp'}')" title="Delete message">✕</button>
        </div>` : '';
      
      messageBubble.innerHTML = `
        ${deleteButton}
        <p class="message-text">${message.content || message.text || ''}</p>
        <div class="message-time">${message.created_at || message.timestamp || 'Just now'}</div>
      `;
      
      messagesArea.appendChild(messageBubble);
      scrollToBottom();
      
      // Remove "no messages" text if it exists
      const noMessages = messagesArea.querySelector('.no-messages');
      if (noMessages) {
        noMessages.remove();
      }
    }

    // Delete message function
    function deleteMessage(messageId) {
      if (!confirm('Delete this message?')) return;
      
      fetch(`/api/message/delete/${messageId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
          if (messageElement) {
            messageElement.style.opacity = '0';
            messageElement.style.transform = 'translateX(-20px)';
            setTimeout(() => {
              messageElement.remove();
              
              // Check if no messages left
              const messages = document.querySelectorAll('.message-bubble');
              if (messages.length === 0) {
                const messagesArea = document.getElementById('messagesArea');
                if (messagesArea) {
                  messagesArea.innerHTML = `
                    <div class="no-messages">
                      <p>No messages yet. Start the conversation!</p>
                    </div>
                  `;
                }
              }
            }, 300);
          }
        } else {
          alert('Failed to delete message: ' + (data.message || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error deleting message:', error);
        alert('Error deleting message. Please try again.');
      });
    }

    // Send message - FIXED VERSION
    function sendMessage() {
      if (!messageInput || !sendButton) {
        console.error('Message input or send button not found');
        return;
      }
      
      const messageText = messageInput.value.trim();
      
      if (!messageText) {
        console.log('No message text');
        return;
      }

      if (otherUserId === 0) {
        alert('Cannot send message: Invalid user ID');
        return;
      }

      console.log('Sending message to user:', otherUserId);
      console.log('Message text:', messageText);

      // Disable input and button while sending
      messageInput.disabled = true;
      sendButton.disabled = true;

      // Add temporary message to UI
      const tempMessage = {
        id: 'temp_' + Date.now(),
        content: messageText,
        created_at: 'Sending...',
        is_own: true
      };
      
      addMessageToUI(tempMessage, true);

      // Clear input
      messageInput.value = '';
      autoResizeTextarea();

      // Send to server - FIXED: Use proper FormData
      const formData = new FormData();
      formData.append('message', messageText);
      formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
      
      fetch(`/api/message/send/${otherUserId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
        },
        body: formData
      })
      .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('Send response:', data);
        if (data.status === 'success') {
          // Find and update the temporary message
          const tempMessages = document.querySelectorAll('.message-bubble');
          const lastMessage = tempMessages[tempMessages.length - 1];
          
          if (lastMessage && lastMessage.querySelector('.message-time').textContent === 'Sending...') {
            lastMessage.setAttribute('data-message-id', data.message_id || data.id);
            const timeElement = lastMessage.querySelector('.message-time');
            if (timeElement) {
              timeElement.textContent = data.timestamp || new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
          }
          
          // Show success notification
          showNotification('Message sent!', 'success');
        } else {
          // Remove temporary message if failed
          const tempMessages = document.querySelectorAll('.message-bubble');
          const lastMessage = tempMessages[tempMessages.length - 1];
          if (lastMessage && lastMessage.querySelector('.message-time').textContent === 'Sending...') {
            lastMessage.remove();
          }
          alert('Failed to send message: ' + (data.message || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error sending message:', error);
        // Remove temporary message
        const tempMessages = document.querySelectorAll('.message-bubble');
        const lastMessage = tempMessages[tempMessages.length - 1];
        if (lastMessage && lastMessage.querySelector('.message-time').textContent === 'Sending...') {
          lastMessage.remove();
        }
        alert('Failed to send message. Please check your connection and try again.');
      })
      .finally(() => {
        // Re-enable input and button
        if (messageInput && sendButton) {
          messageInput.disabled = false;
          sendButton.disabled = false;
          messageInput.focus();
        }
      });
    }

    // Function to show notification
    function showNotification(message, type = 'success') {
      // Remove existing notifications
      const existing = document.querySelector('.action-notification');
      if (existing) existing.remove();
      
      // Create notification
      const notification = document.createElement('div');
      notification.className = `action-notification notification-${type}`;
      notification.innerHTML = `
          <div class="notification-content">
              <span>${message}</span>
          </div>
      `;
      
      // Add styles if not already present
      if (!document.querySelector('#notification-styles')) {
        const styles = document.createElement('style');
        styles.id = 'notification-styles';
        styles.textContent = `
          .action-notification {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          }
          .notification-success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border-left: 4px solid #2E7D32;
          }
          .notification-error {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            border-left: 4px solid #b71c1c;
          }
          .notification-info {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            border-left: 4px solid #0D47A1;
          }
          @keyframes slideIn {
            from {
              transform: translateX(100%);
              opacity: 0;
            }
            to {
              transform: translateX(0);
              opacity: 1;
            }
          }
          @keyframes fadeOut {
            from {
              opacity: 1;
            }
            to {
              opacity: 0;
            }
          }
        `;
        document.head.appendChild(styles);
      }
      
      document.body.appendChild(notification);
      
      // Auto-remove after 3 seconds
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 3000);
    }

    // Event listeners
    if (messageInput) {
      messageInput.addEventListener('input', autoResizeTextarea);
      messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    if (sendButton) {
      sendButton.addEventListener('click', sendMessage);
    }

    // Initial setup
    scrollToBottom();
    autoResizeTextarea();
    
    if (messageInput) {
      messageInput.focus();
    }

    // Expose functions to window
    window.deleteMessage = deleteMessage;
    window.sendMessageFunc = sendMessage;
  });
</script>
{% endblock %}
