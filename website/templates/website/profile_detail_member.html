{% extends 'website/synergy_base_header.html' %}
{% load static %}

{% block content %}
<style>
  :root {
    --brand: #cdad7c;
    --brand-dark: #a88a5a;
    --brand-soft: #e7d3af;
    --bg: #050509;
    --bg-soft: #090b12;
    --bg-elevated: #0b0e18;
    --card: rgba(15, 23, 42, 0.96);
    --card-soft: rgba(15, 23, 42, 0.9);
    --text: #f9fafb;
    --text-soft: #9ca3af;
    --text-muted: #6b7280;
    --text-gold: #f5e6c5;
    --border: rgba(148, 163, 184, 0.45);
    --border-soft: rgba(148, 163, 184, 0.2);
    --shadow-soft: 0 20px 60px rgba(15, 23, 42, 0.9);
    --shadow-strong: 0 30px 80px rgba(0, 0, 0, 0.95);
    --radius: 20px;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    margin: 0;
    padding: 0;
    min-height: 100vh;
  }

  .profile-container {
    margin-top: 100px;
    padding: 2rem;
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
  }

  /* CLEAN BACK BUTTON - Only for profile-to-profile navigation */
  .profile-back-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-gold);
    text-decoration: none;
    margin-bottom: 2rem;
    padding: 0.8rem 1.5rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    transition: all 0.3s ease;
    background: rgba(15, 23, 42, 0.8);
    backdrop-filter: blur(10px);
    font-weight: 600;
  }

  .profile-back-button:hover {
    background: rgba(205, 173, 119, 0.1);
    transform: translateX(-5px);
    border-color: var(--brand);
  }

  .profile-details {
    display: grid;
    grid-template-columns: 400px 1fr;
    gap: 3rem;
    align-items: flex-start;
  }

  .profile-image-section {
    position: relative;
  }

  .profile-main-image {
    width: 100%;
    height: 500px;
    background-size: cover;
    background-position: center;
    background-color: #2c3e50;
    border-radius: 24px;
    border: 1px solid rgba(148, 163, 184, 0.6);
    position: relative;
    overflow: hidden;
    box-shadow: var(--shadow-soft);
    cursor: pointer;
    background-repeat: no-repeat;
  }

  .profile-main-image::before {
    content: "";
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at top, rgba(248, 250, 252, 0.2), transparent 55%);
    mix-blend-mode: soft-light;
    opacity: 0.7;
  }

  .profile-main-image::after {
    content: "";
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at bottom, rgba(15, 23, 42, 0.7), transparent 50%);
  }

  .gallery-section {
    margin-top: 1.5rem;
  }

  .section-title {
    font-size: 0.8rem;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 0.6rem;
  }

  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 0.8rem;
  }

  .gallery-item {
    position: relative;
    width: 100%;
    height: 120px;
    border-radius: 14px;
    overflow: hidden;
    border: 1px solid rgba(148, 163, 184, 0.6);
    background-size: cover;
    background-position: center;
    background-color: #2c3e50;
    cursor: pointer;
    background-repeat: no-repeat;
  }

  .gallery-item::after {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(to top, rgba(15, 23, 42, 0.7), transparent 45%);
    opacity: 0;
    transition: opacity 0.25s ease;
  }

  .gallery-item:hover::after {
    opacity: 1;
  }

  /* PRIVATE IMAGES STYLING */
  .private-image {
    position: relative;
  }

  .private-overlay {
    position: absolute;
    inset: 0;
    background: rgba(15, 23, 42, 0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.8;
    transition: opacity 0.3s ease;
  }

  .private-image:hover .private-overlay {
    opacity: 0.5;
  }

  .private-overlay svg {
    stroke: var(--brand);
    width: 24px;
    height: 24px;
  }

  /* BLURRED PRIVATE GALLERY STYLING */
  .private-gallery-section {
    margin-top: 1.5rem;
    padding: 1.5rem;
    background: rgba(15, 23, 42, 0.7);
    border-radius: var(--radius);
    border: 1px solid rgba(148, 163, 184, 0.4);
  }

  .private-gallery-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .private-gallery-title {
    font-size: 0.9rem;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    color: var(--text-gold);
  }

  .private-gallery-lock {
    width: 16px;
    height: 16px;
    stroke: var(--text-gold);
  }

  .private-gallery-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.8rem;
  }

  .private-gallery-item {
    position: relative;
    width: 100%;
    height: 100px;
    border-radius: 10px;
    overflow: hidden;
    background: linear-gradient(135deg, #1a202c, #2d3748);
    border: 1px solid rgba(148, 163, 184, 0.4);
    filter: blur(4px);
  }

  .private-gallery-item::before {
    content: "ðŸ”’ PRIVATE";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.7rem;
    letter-spacing: 0.1em;
    color: var(--text-gold);
    z-index: 2;
  }

  .private-gallery-actions {
    margin-top: 1rem;
    display: flex;
    justify-content: center;
  }

  .request-access-btn {
    background: linear-gradient(135deg, var(--brand), var(--brand-dark));
    color: #000;
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 999px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 10px 25px rgba(205, 173, 119, 0.3);
  }

  .request-access-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 15px 30px rgba(205, 173, 119, 0.4);
  }

  .request-access-btn:active {
    transform: translateY(0);
  }

  .private-gallery-note {
    margin-top: 1rem;
    font-size: 0.8rem;
    color: var(--text-muted);
    text-align: center;
    line-height: 1.5;
  }

  .profile-info-section {
    background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.96));
    border-radius: var(--radius);
    border: 1px solid rgba(148, 163, 184, 0.55);
    box-shadow: var(--shadow-strong);
    padding: 2.1rem 2.4rem;
    position: relative;
    overflow: hidden;
  }

  .profile-info-section::before {
    content: "";
    position: absolute;
    top: -120px;
    right: -120px;
    width: 260px;
    height: 260px;
    background: radial-gradient(circle, rgba(205, 173, 124, 0.14), transparent 70%);
    opacity: 0.7;
    pointer-events: none;
  }

  .profile-info-section-inner {
    position: relative;
    z-index: 1;
  }

  .profile-header {
    margin-bottom: 1.5rem;
  }

  .profile-name-large {
    font-size: 2.8rem;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    margin: 0;
    color: var(--text-gold);
  }

  .profile-details-large {
    margin: 0.6rem 0 0.3rem;
    color: var(--text-soft);
    font-size: 0.9rem;
    letter-spacing: 0.16em;
    text-transform: uppercase;
  }

  .profile-bio-large {
    margin: 0.6rem 0 0;
    color: var(--text-gold);
    font-size: 1rem;
    line-height: 1.8;
    font-style: italic;
  }

  .arrangement-section {
    margin-top: 1.6rem;
  }

  .arrangement-section .section-title {
    font-size: 1.1rem;
    letter-spacing: 0.16em;
    color: var(--text-gold);
    margin-bottom: 1rem;
    border-bottom: 1px solid rgba(148, 163, 184, 0.3);
    padding-bottom: 0.5rem;
  }

  .arrangement-tags-large {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .arrangement-tag-large {
    padding: 0.7rem 1.1rem;
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.7);
    font-size: 0.85rem;
    color: var(--text-soft);
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.98));
  }

  .divider-line {
    margin: 1.6rem 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(148, 163, 184, 0.7), transparent);
  }

  .about-section {
    margin-top: 1.4rem;
  }

  .about-section .section-title {
    font-size: 1.1rem;
    letter-spacing: 0.16em;
    color: var(--text-gold);
    margin-bottom: 1rem;
    border-bottom: 1px solid rgba(148, 163, 184, 0.3);
    padding-bottom: 0.5rem;
  }

  .about-content {
    color: var(--text-soft);
    line-height: 1.8;
    font-size: 0.96rem;
  }

  .about-content p {
    margin: 0 0 1.2rem;
  }

  .about-content strong {
    color: var(--text-gold);
    font-weight: 600;
  }

  .about-columns {
    display: grid;
    grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
    gap: 2rem;
  }

  .lifestyle-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    max-height: 120px;
    overflow-y: auto;
    padding-right: 5px;
  }

  .lifestyle-tags::-webkit-scrollbar {
    width: 4px;
  }

  .lifestyle-tags::-webkit-scrollbar-track {
    background: rgba(148, 163, 184, 0.1);
    border-radius: 2px;
  }

  .lifestyle-tags::-webkit-scrollbar-thumb {
    background: var(--brand);
    border-radius: 2px;
  }

  .pill-subtle {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.25rem 0.85rem;
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.6);
    font-size: 0.8rem;
    color: var(--text-soft);
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 1));
    white-space: nowrap;
    flex-shrink: 0;
  }

  .profile-actions {
    display: flex;
    gap: 0.8rem;
    margin-top: 1.8rem;
  }

  .btn {
    padding: 0.9rem 1.3rem;
    border-radius: 999px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--brand), var(--brand-dark));
    color: #000;
    box-shadow: 0 14px 35px rgba(205, 173, 119, 0.45);
    flex: 1.1;
  }

  .btn-secondary {
    background: transparent;
    color: var(--text);
    border: 1px solid rgba(148, 163, 184, 0.8);
    flex: 1;
  }

  .btn-danger {
    background: transparent;
    color: #ef4444;
    border: 1px solid #ef4444;
    flex: 1;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 14px 30px rgba(0, 0, 0, 0.6);
  }

  .btn-danger:hover {
    background: rgba(239, 68, 68, 0.1);
  }

  .profile-nav-bottom {
    display: flex;
    justify-content: space-between;
    gap: 0.9rem;
    margin-top: 2rem;
  }

  .profile-nav-btn {
    flex: 1;
    text-align: center;
    background: linear-gradient(135deg, var(--brand), var(--brand-dark));
    color: #000;
    padding: 0.7rem 1.2rem;
    border-radius: 999px;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.9rem;
    border: 1px solid rgba(0, 0, 0, 0.6);
    box-shadow: 0 10px 25px rgba(205, 173, 119, 0.3);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .profile-nav-btn:hover {
    background: var(--brand-dark);
    transform: translateY(-2px);
  }

  /* MOBILE PROFILE NAVIGATION OPTIMIZATION */
  @media (max-width: 768px) {
    .profile-nav-bottom {
      flex-direction: row !important;
      gap: 0.5rem;
      margin-top: 1.5rem;
    }

    .profile-nav-btn {
      padding: 0.6rem 0.8rem !important;
      font-size: 0.8rem !important;
      min-height: 44px;
    }

    .profile-nav-btn svg {
      width: 14px !important;
      height: 14px !important;
    }

    .nav-btn-text {
      display: inline;
    }
  }

  /* For very small screens, compact buttons */
  @media (max-width: 480px) {
    .profile-nav-btn {
      padding: 0.5rem 0.7rem !important;
      font-size: 0.75rem !important;
      min-height: 40px;
    }

    .profile-nav-btn svg {
      width: 12px !important;
      height: 12px !important;
    }

    .nav-btn-text {
      display: inline;
    }
  }

  /* LIGHTBOX STYLES */
  .lightbox-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.94);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1500;
    padding: 1rem;
  }

  .lightbox-overlay.open {
    display: flex;
  }

  .lightbox-content {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
    width: auto;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .lightbox-image {
    max-width: 85vw;
    max-height: 85vh;
    width: auto;
    height: auto;
    border-radius: 20px;
    box-shadow: var(--shadow-strong);
    display: block;
    object-fit: contain;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
    transition: opacity 0.3s ease;
  }

  .lightbox-image.loading {
    opacity: 0;
  }

  .lightbox-image.loaded {
    opacity: 1;
  }

  .lightbox-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: var(--brand);
    animation: spin 1s ease-in-out infinite;
    display: none;
  }

  @keyframes spin {
    to { transform: translate(-50%, -50%) rotate(360deg); }
  }

  .lightbox-loading.show {
    display: block;
  }

  .lightbox-close, .lightbox-arrow {
    position: absolute;
    background: rgba(15, 23, 42, 0.85);
    border: 1px solid rgba(148, 163, 184, 0.7);
    color: #f9fafb;
    width: 44px;
    height: 44px;
    border-radius: 999px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    z-index: 1501;
  }

  .lightbox-close:hover, .lightbox-arrow:hover {
    background: rgba(15, 23, 42, 0.95);
    transform: scale(1.05);
  }

  .lightbox-close {
    top: 20px;
    right: 20px;
  }

  .lightbox-arrow.prev {
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
  }

  .lightbox-arrow.next {
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
  }

  /* Responsive */
  @media (max-width: 968px) {
    .profile-details {
      grid-template-columns: 1fr;
    }

    .profile-main-image {
      height: 400px;
    }

    .about-columns {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .profile-container {
      padding: 1rem;
      margin-top: 80px;
    }

    .profile-name-large {
      font-size: 2rem;
      text-align: center;
    }

    .gallery-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .private-gallery-grid {
      grid-template-columns: 1fr;
    }

    .profile-actions {
      flex-direction: column;
    }

    .btn {
      width: 100%;
      justify-content: center;
    }

    .profile-info-section {
      padding: 1.5rem;
    }

    .profile-nav-bottom {
      flex-direction: row;
    }

    .profile-nav-btn {
      width: auto;
    }
  }
</style>

<div class="profile-container">
  <!-- SIMPLE BACK BUTTON - Only for profile-to-profile navigation -->
  <a href="{% url 'dashboard' %}" class="profile-back-button">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
         xmlns="http://www.w3.org/2000/svg" stroke="currentColor"
         stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="19" y1="12" x2="5" y2="12"></line>
      <polyline points="12 19 5 12 12 5"></polyline>
    </svg>
    Back to Dashboard
  </a>

  <section class="profile-details">
    <div class="profile-image-section">
      <div class="profile-main-image"
        {% if profile.profile_image %}
          style="background-image:url('{{ profile.profile_image }}');"
        {% elif profile.profile_image_url %}
          style="background-image:url('{{ profile.profile_image_url }}');"
        {% else %}
          style="background-image:url('{% static 'images/default-profile.jpg' %}');"
        {% endif %}>
      </div>

      {% if profile.additional_images %}
      <div class="gallery-section">
        <h3 class="section-title">Gallery</h3>
        <div class="gallery-grid">
          {% for image_url in profile.additional_images %}
            {% if image_url %}
              <div class="gallery-item" style="background-image:url('{{ image_url }}');"></div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- PRIVATE IMAGES SECTION -->
      {% if has_private_images %}
        {% if has_private_access or user.is_staff %}
          <div class="private-gallery-section" style="margin-top: 2rem;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.6rem;">
              <h3 class="section-title">Private Gallery</h3>
              <span class="pill-subtle" style="background: rgba(205, 173, 119, 0.1); color: var(--brand); border-color: var(--brand);">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.25rem;">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                Private
              </span>
            </div>
            
            <div class="gallery-grid">
              {% if private_images %}
                {% for img in private_images %}
                  {% if img.image.url %}
                    <div class="gallery-item private-image" style="background-image:url('{{ img.image.url }}');">
                      <div class="private-overlay">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                          <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                      </div>
                    </div>
                  {% elif img.url %}
                    <div class="gallery-item private-image" style="background-image:url('{{ img.url }}');">
                      <div class="private-overlay">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                          <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              {% endif %}
            </div>
            
            {% if private_images|length == 0 %}
              <p style="color: var(--text-muted); font-style: italic; text-align: center; padding: 1rem;">
                No private photos added yet
              </p>
            {% endif %}
          </div>
        {% else %}
          <!-- BLURRED PRIVATE IMAGES SECTION -->
          <div class="private-gallery-section">
            <div class="private-gallery-header">
              <span class="private-gallery-title">Private Gallery</span>
              <svg class="private-gallery-lock" viewBox="0 0 24 24">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>
            </div>
            <div class="private-gallery-grid">
              <div class="private-gallery-item"></div>
              <div class="private-gallery-item"></div>
              <div class="private-gallery-item"></div>
              <div class="private-gallery-item"></div>
            </div>
            
            <div class="private-gallery-actions">
              <button class="request-access-btn" onclick="requestPrivateAccess({{ profile.user_id }})" aria-label="Request access to private gallery">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Request Access
              </button>
            </div>
            
            <p class="private-gallery-note">
              Private gallery available to trusted members.<br>
              Request access with a personalised message.
            </p>
          </div>
        {% endif %}
      {% endif %}
    </div>

    <article class="profile-info-section">
      <div class="profile-info-section-inner">
        <header class="profile-header">
          <h1 class="profile-name-large">{{ profile.display_name|default:profile.username|default:"Member"|upper }}</h1>
          <p class="profile-details-large">
            {{ profile.age|default:"Not provided" }} â€¢ {{ profile.location|default:"Location not provided" }}
          </p>
          
          <!-- PROFILE HEADING SECTION -->
          {% if profile.profile_heading and profile.profile_heading.strip %}
          <section class="arrangement-section">
              <h3 class="section-title">Profile Heading</h3>
              <div class="arrangement-tags-large">
                  <span class="arrangement-tag-large">{{ profile.profile_heading }}</span>
              </div>
          </section>
          {% endif %}
        </header>

        <div class="divider-line"></div>

        <section class="about-section">
          <h3 class="section-title">About Me</h3>
          <div class="about-columns">
            <div class="about-content">
              {% if profile.description and profile.description != "No description provided yet." %}
                <p>{{ profile.description }}</p>
              {% elif profile.story and profile.story != "No story provided yet." %}
                <p>{{ profile.story }}</p>
              {% else %}
                <p>No description provided yet.</p>
              {% endif %}
              
              {% if profile.looking_for %}
                <p>
                  <strong>Looking For:</strong>
                  {{ profile.looking_for }}
                </p>
              {% endif %}
              
              {% if profile.relationship_status and profile.relationship_status != "Not provided" %}
                <p>
                  <strong>Relationship Status:</strong>
                  {{ profile.relationship_status }}
                </p>
              {% endif %}
            </div>

            <aside>
              <h3 class="section-title">Lifestyle &amp; Details</h3>
              <div class="lifestyle-tags">
                {% if profile.body_type and profile.body_type != "Not provided" %}
                  <span class="pill-subtle">Body â€¢ {{ profile.body_type }}</span>
                {% endif %}
                
                <!-- FIXED: Show "None" for blank children field -->
                {% if profile.children and profile.children.strip %}
                  <span class="pill-subtle">Children â€¢ {{ profile.children }}</span>
                {% else %}
                  <span class="pill-subtle">Children â€¢ None</span>
                {% endif %}
                
                {% if profile.smoker and profile.smoker != "Not provided" %}
                  <span class="pill-subtle">Smoker â€¢ {{ profile.smoker }}</span>
                {% elif profile.is_smoker %}
                  <span class="pill-subtle">Smoker â€¢ Yes</span>
                {% else %}
                  <span class="pill-subtle">Smoker â€¢ No</span>
                {% endif %}
                
                {% if profile.height and profile.height != "Not provided" %}
                  <span class="pill-subtle">Height â€¢ {{ profile.height }}</span>
                {% endif %}
                
                <!-- GROUP PERSONALITY TRAITS -->
                {% if profile.personality_traits or profile.communication_style %}
                  <span class="pill-subtle">
                    {% if profile.personality_traits %}{{ profile.personality_traits }}{% endif %}
                    {% if profile.personality_traits and profile.communication_style %} â€¢ {% endif %}
                    {% if profile.communication_style %}{{ profile.communication_style }}{% endif %}
                  </span>
                {% endif %}
                
                <!-- GROUP VALUES & PRIORITIES -->
                {% if profile.life_priorities or profile.core_values %}
                  <span class="pill-subtle">
                    {% if profile.life_priorities %}{{ profile.life_priorities }}{% endif %}
                    {% if profile.life_priorities and profile.core_values %} â€¢ {% endif %}
                    {% if profile.core_values %}{{ profile.core_values }}{% endif %}
                  </span>
                {% endif %}
                
                <!-- INTERESTS -->
                {% if profile.lifestyle_interests %}
                  <span class="pill-subtle">Interests â€¢ {{ profile.lifestyle_interests }}</span>
                {% endif %}
                
                <!-- ARRANGEMENT PREFERENCES -->
                {% if profile.arrangement_preferences %}
                  <span class="pill-subtle">Seeks â€¢ {{ profile.arrangement_preferences }}</span>
                {% endif %}
                
                <!-- ADDITIONAL FIELDS FROM CSV -->
                {% if profile.age_min or profile.age_max %}
                  <span class="pill-subtle">
                    Age Range â€¢ 
                    {% if profile.age_min %}{{ profile.age_min|floatformat:0 }}{% endif %}
                    {% if profile.age_min and profile.age_max %}-{% endif %}
                    {% if profile.age_max %}{{ profile.age_max|floatformat:0 }}{% endif %}
                  </span>
                {% endif %}
                
                {% if profile.location_preference %}
                  <span class="pill-subtle">Prefers â€¢ {{ profile.location_preference }}</span>
                {% endif %}
                
                {% if profile.max_distance %}
                  <span class="pill-subtle">Within â€¢ {{ profile.max_distance }}</span>
                {% endif %}
                
                {% if not profile.body_type and not profile.children and not profile.smoker and not profile.height and not profile.personality_traits and not profile.communication_style and not profile.life_priorities and not profile.core_values and not profile.lifestyle_interests and not profile.arrangement_preferences and not profile.age_min and not profile.age_max and not profile.location_preference and not profile.max_distance %}
                  <span class="pill-subtle">No lifestyle details provided</span>
                {% endif %}
              </div>
            </aside>
          </div>
        </section>

        <div class="profile-actions">
          <!-- REAL FUNCTIONALITY FOR LOGGED-IN MEMBERS -->
          <button class="btn btn-primary" onclick="sendMessage({{ profile.user_id }})" aria-label="Send message to {{ profile.display_name|default:profile.username }}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            Send Message
          </button>
          
          <button class="btn btn-secondary" onclick="toggleFavorite({{ profile.user_id }})" id="favorite-btn" aria-label="{% if is_favorited %}Remove from favorites{% else %}Add to favorites{% endif %}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
            {% if is_favorited %}Remove Favorite{% else %}Add to Favorites{% endif %}
          </button>
          
          <button class="btn btn-danger" onclick="toggleBlock({{ profile.user_id }})" id="block-btn" aria-label="{% if is_blocked %}Unblock user{% else %}Block user{% endif %}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 6L6 18M6 6l12 12"></path>
            </svg>
            {% if is_blocked %}Unblock User{% else %}Block User{% endif %}
          </button>
        </div>

        <!-- COMPACT PROFILE NAVIGATION - Previous/Next on same line -->
        {% if prev_id or next_id %}
        <div class="profile-nav-bottom">
          {% if prev_id %}
            <a href="{% url 'profile_detail_member' prev_id %}" class="profile-nav-btn" id="prev-btn" aria-label="Previous profile">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
              <span class="nav-btn-text">Prev</span>
            </a>
          {% else %}
            <span class="profile-nav-btn" style="background: var(--bg-soft); color: var(--text-muted); cursor: not-allowed; opacity: 0.5;" aria-disabled="true">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
              <span class="nav-btn-text">Prev</span>
            </span>
          {% endif %}
          
          {% if next_id %}
            <a href="{% url 'profile_detail_member' next_id %}" class="profile-nav-btn" id="next-btn" aria-label="Next profile">
              <span class="nav-btn-text">Next</span>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </a>
          {% else %}
            <span class="profile-nav-btn" style="background: var(--bg-soft); color: var(--text-muted); cursor: not-allowed; opacity: 0.5;" aria-disabled="true">
              <span class="nav-btn-text">Next</span>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </span>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </article>
  </section>
</div>

<!-- LIGHTBOX HTML -->
<div class="lightbox-overlay" id="lightbox-overlay" role="dialog" aria-modal="true" aria-label="Image gallery" style="display: none;">
  <div class="lightbox-content">
    <button class="lightbox-close" id="lightbox-close" aria-label="Close lightbox">&times;</button>
    <button class="lightbox-arrow prev" id="lightbox-prev" aria-label="Previous image">&#8249;</button>
    <div class="lightbox-loading" id="lightbox-loading"></div>
    <img src="" alt="" class="lightbox-image" id="lightbox-image" loading="lazy">
    <button class="lightbox-arrow next" id="lightbox-next" aria-label="Next image">&#8250;</button>
  </div>
</div>

<script>
// Initialize profile navigation if not exists
if (!window.profileNavigation) {
    window.profileNavigation = {
        storeProfileContext: function(profileId, profileUrl, profileName) {
            try {
                sessionStorage.setItem('lastProfileId', profileId);
                sessionStorage.setItem('lastProfileUrl', profileUrl);
                sessionStorage.setItem('lastProfileName', profileName || 'Member');
            } catch (e) {
                console.warn('Could not store profile context:', e);
            }
        }
    };
}

// Store the current profile context when viewing a profile
function storeProfileContext() {
    const profileId = {{ profile.user_id }};
    const profileUrl = window.location.href;
    const profileName = "{{ profile.display_name|default:profile.username|default:'Member' }}";
    
    window.profileNavigation.storeProfileContext(profileId, profileUrl, profileName);
}

function sendMessage(userId) {
    storeProfileContext();
    window.location.href = "{% url 'message_detail' 0 %}".replace('0', userId);
}

function toggleFavorite(userId) {
    storeProfileContext();
    fetch("{% url 'favorite_profile' 0 %}".replace('0', userId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            const btn = document.getElementById('favorite-btn');
            if (data.action === 'favorited') {
                btn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"></path>
                    </svg>
                    Remove Favorite
                `;
                btn.setAttribute('aria-label', 'Remove from favorites');
            } else {
                btn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"></path>
                    </svg>
                    Add to Favorites
                `;
                btn.setAttribute('aria-label', 'Add to favorites');
            }
        } else {
            alert('Failed to update favorite: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating favorite. Please try again.');
    });
}

function toggleBlock(userId) {
    storeProfileContext();
    const isBlocked = {% if is_blocked %}true{% else %}false{% endif %};
    
    if (isBlocked) {
        // Unblock user
        fetch("{% url 'unblock_profile' 0 %}".replace('0', userId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                const btn = document.getElementById('block-btn');
                btn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"></path>
                    </svg>
                    Block User
                `;
                btn.setAttribute('aria-label', 'Block user');
            } else {
                alert('Failed to unblock user: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error unblocking user. Please try again.');
        });
    } else {
        // Block user
        if (confirm('Are you sure you want to block this user? You will no longer see their profile and they will not be able to contact you.')) {
            fetch("{% url 'block_profile' 0 %}".replace('0', userId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    const btn = document.getElementById('block-btn');
                    btn.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"></path>
                        </svg>
                        Unblock User
                    `;
                    btn.setAttribute('aria-label', 'Unblock user');
                } else {
                    alert('Failed to block user: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error blocking user. Please try again.');
            });
        }
    }
}

function requestPrivateAccess(userId) {
    storeProfileContext();
    
    if (!confirm('Request private photo access from this member?')) return;
    
    // Check if request_private_access URL exists in Django URLs
    const requestUrl = "{% url 'request_private_access' 0 %}".replace('0', userId);
    
    fetch(requestUrl, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        if (!response.ok) {
            if (response.status === 404) {
                throw new Error('Private access feature is not available');
            }
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            alert('Private access request sent! You\'ll be notified when approved.');
        } else if (data.status === 'already_requested') {
            alert('You already have a pending request.');
        } else {
            alert('Error sending request: ' + (data.message || 'Please try again.'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (error.message.includes('not available')) {
            alert('Private access feature is currently unavailable.');
        } else {
            alert('Error sending request. Please try again.');
        }
    });
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Store current profile context using the new system
    storeProfileContext();
    
    // Keyboard navigation for profiles (only when lightbox is not open)
    document.addEventListener('keydown', function(e) {
        const lightboxOpen = document.getElementById('lightbox-overlay').style.display === 'flex';
        
        if (!lightboxOpen) {
            if (e.key === 'ArrowLeft' && {% if prev_id %}true{% else %}false{% endif %}) {
                e.preventDefault();
                const prevBtn = document.getElementById('prev-btn');
                if (prevBtn && prevBtn.tagName === 'A') {
                    prevBtn.click();
                }
            }
            if (e.key === 'ArrowRight' && {% if next_id %}true{% else %}false{% endif %}) {
                e.preventDefault();
                const nextBtn = document.getElementById('next-btn');
                if (nextBtn && nextBtn.tagName === 'A') {
                    nextBtn.click();
                }
            }
        }
    });

    // LIGHTBOX FUNCTIONALITY
    const mainImageDiv = document.querySelector('.profile-main-image');
    const galleryItems = document.querySelectorAll('.gallery-item:not(.private-image)');
    const privateImages = document.querySelectorAll('.private-image');
    const lightbox = document.getElementById('lightbox-overlay');
    const lightboxImg = document.getElementById('lightbox-image');
    const lightboxLoading = document.getElementById('lightbox-loading');
    const btnClose = document.getElementById('lightbox-close');
    const btnPrev = document.getElementById('lightbox-prev');
    const btnNext = document.getElementById('lightbox-next');

    const imageUrls = [];
    
    if (mainImageDiv) {
      const mainImageStyle = mainImageDiv.style.backgroundImage;
      if (mainImageStyle && mainImageStyle !== 'none') {
        const mainImageUrl = mainImageStyle.replace('url("', '').replace('")', '');
        if (mainImageUrl && !mainImageUrl.includes('default-profile')) {
          imageUrls.push(mainImageUrl);
        }
      }
    }
    
    galleryItems.forEach(item => {
      const imageStyle = item.style.backgroundImage;
      if (imageStyle && imageStyle !== 'none') {
        const imageUrl = imageStyle.replace('url("', '').replace('")', '');
        if (imageUrl) {
          imageUrls.push(imageUrl);
        }
      }
    });

    // Add private images if user has access
    {% if has_private_images and has_private_access or user.is_staff %}
    privateImages.forEach(item => {
      const imageStyle = item.style.backgroundImage;
      if (imageStyle && imageStyle !== 'none') {
        const imageUrl = imageStyle.replace('url("', '').replace('")', '');
        if (imageUrl) {
          imageUrls.push(imageUrl);
        }
      }
    });
    {% endif %}

    let currentIndex = 0;

    function showImage(idx) {
      if (!imageUrls.length) return;
      if (idx < 0) idx = imageUrls.length - 1;
      if (idx >= imageUrls.length) idx = 0;
      currentIndex = idx;
      
      lightboxImg.classList.add('loading');
      lightboxLoading.classList.add('show');
      
      const img = new Image();
      img.src = imageUrls[currentIndex];
      
      img.onload = function() {
        lightboxImg.src = imageUrls[currentIndex];
        lightboxImg.alt = 'Gallery image ' + (currentIndex + 1) + ' of ' + imageUrls.length;
        lightboxImg.classList.remove('loading');
        lightboxImg.classList.add('loaded');
        lightboxLoading.classList.remove('show');
        lightbox.setAttribute('aria-label', 'Image gallery - ' + (currentIndex + 1) + ' of ' + imageUrls.length);
      };
      
      img.onerror = function() {
        lightboxLoading.classList.remove('show');
        lightboxImg.alt = 'Image failed to load';
        lightboxImg.src = '';
      };
    }

    function openLightbox(idx) {
      if (!imageUrls.length) return;
      showImage(idx);
      lightbox.style.display = 'flex';
      lightbox.classList.add('open');
      document.body.style.overflow = 'hidden';
      document.getElementById('lightbox-close').focus();
    }

    function closeLightbox() {
      lightbox.style.display = 'none';
      lightbox.classList.remove('open');
      lightboxImg.src = '';
      lightboxImg.classList.remove('loaded');
      document.body.style.overflow = '';
    }

    function preloadAdjacentImages() {
      const preloadIndices = [
        (currentIndex - 1 + imageUrls.length) % imageUrls.length,
        (currentIndex + 1) % imageUrls.length
      ];
      
      preloadIndices.forEach(idx => {
        const img = new Image();
        img.src = imageUrls[idx];
      });
    }

    // Main image click handler
    if (mainImageDiv && imageUrls.length) {
      mainImageDiv.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();
        openLightbox(0);
        preloadAdjacentImages();
      });
    }

    // Public gallery items click handler
    galleryItems.forEach((item, i) => {
      item.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();
        const imageStyle = item.style.backgroundImage;
        if (imageStyle && imageStyle !== 'none') {
          const imageUrl = imageStyle.replace('url("', '').replace('")', '');
          const idx = imageUrls.indexOf(imageUrl);
          if (idx !== -1) {
            openLightbox(idx);
            preloadAdjacentImages();
          }
        }
      });
    });

    // Private images click handler
    privateImages.forEach(item => {
      item.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Check if user has access to private images
        {% if has_private_access or user.is_staff %}
            // User has access - proceed with lightbox
            const imageStyle = item.style.backgroundImage;
            if (imageStyle && imageStyle !== 'none') {
                const imageUrl = imageStyle.replace('url("', '').replace('")', '');
                // Add to imageUrls array if not already there
                if (imageUrl && !imageUrls.includes(imageUrl)) {
                    imageUrls.push(imageUrl);
                }
                const idx = imageUrls.indexOf(imageUrl);
                if (idx !== -1) {
                    openLightbox(idx);
                    preloadAdjacentImages();
                }
            }
        {% else %}
            // Show access required message
            alert('Private photos are only available to approved connections. Request access to view.');
        {% endif %}
      });
    });

    // Lightbox controls
    if (btnClose) btnClose.addEventListener('click', closeLightbox);
    if (btnPrev) btnPrev.addEventListener('click', (e) => { e.stopPropagation(); showImage(currentIndex - 1); preloadAdjacentImages(); });
    if (btnNext) btnNext.addEventListener('click', (e) => { e.stopPropagation(); showImage(currentIndex + 1); preloadAdjacentImages(); });

    if (lightbox) {
      lightbox.addEventListener('click', function (e) {
        if (e.target === lightbox) closeLightbox();
      });
    }

    // Keyboard navigation for lightbox
    document.addEventListener('keydown', function (e) {
      const lightboxOpen = lightbox.style.display === 'flex' || lightbox.classList.contains('open');
      
      if (lightboxOpen) {
        if (e.key === 'Escape') {
          closeLightbox();
          e.stopPropagation();
        }
        
        if (e.key === 'ArrowLeft') {
          showImage(currentIndex - 1);
          preloadAdjacentImages();
          e.stopPropagation();
        } else if (e.key === 'ArrowRight') {
          showImage(currentIndex + 1);
          preloadAdjacentImages();
          e.stopPropagation();
        }
      }
    });

    // Add click handlers for private gallery request button (if exists)
    const requestAccessBtn = document.querySelector('.request-access-btn');
    if (requestAccessBtn) {
        requestAccessBtn.addEventListener('click', function(e) {
            e.preventDefault();
            requestPrivateAccess({{ profile.user_id }});
        });
    }

    // Add confirmation for message sending
    const sendMessageBtn = document.querySelector('.btn-primary');
    if (sendMessageBtn) {
        sendMessageBtn.addEventListener('click', function(e) {
            e.preventDefault();
            sendMessage({{ profile.user_id }});
        });
    }
});
</script>
{% endblock %}
