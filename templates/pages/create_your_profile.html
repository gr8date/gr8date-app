{% extends "base_header_preview.html" %}

{% block title %}GR8DATE ‚Ä¢ Create Your Profile{% endblock %}

{% block content %}
</div>
<style>
:root{--brand:#ff2b6a;--brand-900:#e11e5a;--ink:#0f172a;--muted:#64748b;--bg:#f6f7fb;--card:#fff;--border:#eaeef5;--shadow:0 10px 26px rgba(15,23,42,.08)}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink)}
.card{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
.container{max-width:1120px;margin:24px auto;padding:0 16px 80px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:760px){.grid-2{grid-template-columns:1fr}}
.field{display:flex;flex-direction:column;gap:6px}
.field input,.field select,.field textarea{border:1px solid var(--border);border-radius:10px;padding:12px;background:#fff}
.read-only{background:#fbfbfd}
.btn{display:inline-flex;align-items:center;gap:8px;border-radius:9999px;padding:.7rem 1.1rem;border:2px solid transparent;font-weight:700;cursor:pointer}
.btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
.btn-primary:hover{background:var(--brand-900);border-color:var(--brand-900)}
.btn-muted{background:#f2f4f7;border:1px solid var(--border);color:#111}
.btn-disabled{background:#e5e7eb;color:#9ca3af;border-color:#d1d5db;cursor:not-allowed}

/* PROPER BUTTON TABS */
.mobile-tabs{display:flex;background:#f8f9fa;padding:8px;border-radius:12px;margin-bottom:20px;border:1px solid var(--border)}
.tab-button{flex:1;padding:12px 16px;border:none;background:transparent;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:6px}
.tab-button.active{background:white;box-shadow:0 2px 8px rgba(0,0,0,.1);border:1px solid var(--border);color:var(--brand)}
.tab-button:not(.active):hover{background:rgba(255,255,255,0.7)}
.tab-button.disabled{opacity:0.5;cursor:not-allowed}
.settings-section{display:none}
.settings-section.active{display:block}

/* Badges & Status */
.badge{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600;margin-left:8px}
.badge-required{background:#fee2e2;color:#dc2626}
.badge-pending{background:#fef3c7;color:#92400e}

/* SIMPLE PHOTO STYLES */
.photo-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.photo-item{position:relative;width:100%;aspect-ratio:1/1;border-radius:10px;overflow:hidden;border:2px solid #ccc;display:flex;align-items:center;justify-content:center;background:#f0f0f0}
.photo-item img{width:100%;height:100%;object-fit:cover}
.photo-count{font-size:12px;color:#64748b;margin-top:6px}

/* DELETE BUTTON STYLES */
.btn-delete {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 24px;
    height: 24px;
    background: #ff4444;
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    transition: all 0.2s ease;
}
.btn-delete:hover {
    background: #cc0000;
    transform: scale(1.1);
}

/* UPLOAD TRIGGER */
.photo-upload-trigger {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 20px;
    border: 2px dashed #667eea;
    border-radius: 12px;
    background: #f8faff;
    cursor: pointer;
    transition: all 0.3s ease;
    height: 100%;
    min-height: 120px;
}
.photo-upload-trigger:hover {
    background: #f0f4ff;
    border-color: #5a6fd8;
}
.upload-icon {
    font-size: 32px;
    color: #667eea;
}
.upload-text {
    text-align: center;
}
.upload-text h4 {
    margin: 0 0 4px 0;
    color: #334155;
    font-size: 16px;
}
.upload-text p {
    margin: 0;
    font-size: 14px;
    color: #64748b;
}

/* Tag options styles */
.tag-options{display:flex;flex-wrap:wrap;gap:8px;border:1px solid var(--border);border-radius:10px;padding:12px;background:var(--bg-muted);min-height:60px}
.tag-option{display:flex;align-items:center;padding:6px 12px;background:white;border:2px solid #e9ecef;border-radius:20px;cursor:pointer;transition:all 0.3s}
.tag-option:hover{border-color:#667eea;background:#f0f4ff}
.tag-option input[type="checkbox"]{margin-right:6px}
.tag-option input[type="checkbox"]:checked + span{font-weight:bold;color:#667eea}

.badge-note{font-size:12px;color:#64748b;margin-top:6px}

/* Save Actions */
.save-actions{display:flex;flex-direction:column;gap:12px;margin-top:20px;padding:16px;background:#f8f9fa;border-radius:12px;border:1px solid #eaeef5}
.save-main{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:center}

/* Username validation */
.username-status{margin-top:4px;font-size:12px}
.username-available{color:#166534}
.username-taken{color:#dc2626}
.username-checking{color:#64748b}

/* Validation styles */
.field-required label::after{content:" *";color:#dc2626}
.validation-error{border-color:#dc2626 !important;background:#fef2f2}
.error-message{color:#dc2626;font-size:12px;margin-top:4px}
.tab-progress{display:flex;justify-content:center;gap:8px;margin-bottom:16px}
.progress-dot{width:8px;height:8px;border-radius:50%;background:#e5e7eb;transition:all 0.3s}
.progress-dot.active{background:var(--brand)}
.progress-dot.completed{background:#10b981}

/* Success Modal */
.success-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}
.success-modal-content {
    background: white;
    padding: 32px;
    border-radius: 16px;
    max-width: 500px;
    width: 90%;
    text-align: center;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
}
.success-icon {
    font-size: 48px;
    color: #10b981;
    margin-bottom: 16px;
}
.success-title {
    font-size: 24px;
    font-weight: 700;
    margin: 0 0 16px 0;
    color: var(--ink);
}
.success-message {
    color: var(--muted);
    line-height: 1.6;
    margin-bottom: 24px;
}

/* Logout Modal */
.logout-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    align-items: center;
    justify-content: center;
}
.logout-modal-content {
    background: white;
    padding: 32px;
    border-radius: 16px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    border: 1px solid var(--border);
}
.logout-modal-title {
    font-size: 20px;
    font-weight: 700;
    margin: 0 0 16px 0;
    color: var(--ink);
}
.logout-modal-message {
    color: var(--muted);
    line-height: 1.6;
    margin-bottom: 24px;
}
.logout-modal-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
}
</style>

<main class="container">
  <!-- ADMIN REVIEW NOTICE -->
  <div class="card" style="background:#fff3cd;border-color:#ffeaa7;margin-bottom:16px;">
    <div style="display:flex;align-items:center;gap:8px;">
      <span class="material-icons" style="color:#856404">admin_panel_settings</span>
      <div>
        <strong>All profile content requires admin approval</strong>
        <div style="font-size:14px;color:#856404">Complete all sections to submit your profile for review</div>
      </div>
    </div>
  </div>

  <!-- SUCCESS MODAL -->
  <div id="successModal" class="success-modal">
    <div class="success-modal-content">
      <div class="success-icon">üéâ</div>
      <h2 class="success-title">Congratulations!</h2>
      <p class="success-message">
        GR8DATE has received your profile and will endeavour to approve it soonest. 
        We will send you an email regarding this.<br><br>
        <strong>Please check your spam/junk mail box occasionally.</strong>
      </p>
      <button type="button" class="btn btn-primary" onclick="closeSuccessModal()">
        <span class="material-icons">check</span>
        Got It
      </button>
    </div>
  </div>

  <!-- LOGOUT MODAL -->
  <div id="logoutModal" class="logout-modal">
    <div class="logout-modal-content">
      <h3 class="logout-modal-title">Ready to Leave?</h3>
      <p class="logout-modal-message">
        Are you sure you want to log out?<br>
        You'll need to sign in again to access your profile.
      </p>
      <div class="logout-modal-actions">
        <button type="button" class="btn btn-muted" onclick="closeLogoutModal()">
          <span class="material-icons">close</span>
          Cancel
        </button>
        <form method="post" action="{% url 'account_logout' %}" style="margin:0;">
          {% csrf_token %}
          <button type="submit" class="btn btn-primary">
            <span class="material-icons">logout</span>
            Yes, Log Out
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- PROGRESS INDICATOR -->
  <div class="tab-progress">
    <div class="progress-dot active" id="progress-basic"></div>
    <div class="progress-dot" id="progress-preferences"></div>
    <div class="progress-dot" id="progress-profile"></div>
  </div>

  <!-- PROPER BUTTON TABS -->
  <div class="mobile-tabs">
    <button class="tab-button active" data-tab="basic-info">
      <span class="material-icons" style="font-size:18px">person</span>
      Basic Info
    </button>
    <button class="tab-button disabled" data-tab="preferences" id="preferences-tab-btn">
      <span class="material-icons" style="font-size:18px">flash_on</span>
      Lifestyle & Compatibility
    </button>
    <button class="tab-button disabled" data-tab="profile-content" id="profile-tab-btn">
      <span class="material-icons" style="font-size:18px">edit</span>
      Profile & Photos
    </button>
  </div>

  <!-- REAL FORM -->
  <form id="profileForm" method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}

    <!-- Clean header -->
    <div class="card" style="margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <h1 style="margin:0;font-size:22px">Create Your Profile</h1>
      <span class="badge badge-required">
        <span class="material-icons" style="font-size:14px">error</span>
        All Fields Required
      </span>
    </div>

    <!-- BASIC INFO SECTION - ALL FIELDS REQUIRED -->
    <div class="settings-section active" id="basic-info-tab">
      <section class="card">
        <div class="section-header" style="display:flex;align-items:center;margin-bottom:16px">
          <h3 style="margin:0">üë§ Basic Information</h3>
        </div>
        
        <div class="grid-2">
          <!-- Username with real-time validation -->
          <div class="field field-required">
            <label for="username">Username</label>
            <input type="text" id="username" name="username" placeholder="Choose a username" required 
                   value="{{ user.username }}"
                   oninput="checkUsernameAvailability(this.value); validateBasicInfo()">
            <div id="username-status" class="username-status"></div>
            <small class="badge-note">This will be your public profile name</small>
          </div>

          <!-- Age - COMPLETELY INDEPENDENT MANUAL ENTRY -->
          <div class="field field-required">
            <label for="age">Your Displayed Age</label>
            <input type="number" id="age" name="age" min="18" max="80" placeholder="Your age" required
                   oninput="validateBasicInfo()">
            <small class="badge-note">This is the age that will be displayed on your profile</small>
          </div>

          <!-- My Gender -->
          <div class="field field-required">
            <label for="my_gender">My Gender</label>
            <select id="my_gender" name="my_gender" required onchange="validateBasicInfo()">
              <option value="">Select your gender</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
          </div>

          <!-- Looking For -->
          <div class="field field-required">
            <label for="looking_for">Looking For</label>
            <select id="looking_for" name="looking_for" required onchange="validateBasicInfo()">
              <option value="">Select gender preference</option>
              <option value="male">Men</option>
              <option value="female">Women</option>
            </select>
          </div>

          <!-- Email (read-only) -->
          <div class="field">
            <label>Email</label>
            <input class="read-only" value="{{ user.email }}" readonly>
            <small class="badge-note">Your account email</small>
          </div>

          <!-- Date of Birth - FOR DEMOGRAPHICS ONLY, COMPLETELY INDEPENDENT -->
          <div class="field field-required">
            <label for="date_of_birth">Date of Birth</label>
            <input type="date" id="date_of_birth" name="date_of_birth" required
                   onchange="validateBasicInfo()">
          </div>
        </div>

        <!-- Continue button -->
        <div class="save-actions">
          <div class="save-main">
            <button type="button" class="btn btn-primary" id="continue-to-preferences" onclick="switchToTab('preferences')" disabled>
              <span class="material-icons">arrow_forward</span>
              Continue to Lifestyle & Compatibility
            </button>
          </div>
          <div id="basic-info-errors" class="error-message"></div>
        </div>
      </section>
    </div>

    <!-- LIFESTYLE & COMPATIBILITY SECTION - ALL FIELDS REQUIRED -->
    <div class="settings-section" id="preferences-tab">
      <section class="card">
        <div class="section-header" style="display:flex;align-items:center;margin-bottom:8px">
          <h3 style="margin:0">‚ö° Lifestyle & Compatibility</h3>
        </div>
        
        <div class="grid-2">
          <!-- Body Type -->
          <div class="field field-required">
            <label for="body_type">Body Type</label>
            <select id="body_type" name="body_type" required onchange="validatePreferences()">
              <option value="">Select body type</option>
              <option value="slim">Slim</option>
              <option value="athletic">Athletic</option>
              <option value="average">Average</option>
              <option value="curvy">Curvy</option>
              <option value="stocky">Stocky</option>
            </select>
          </div>

          <!-- Relationship & Family -->
          <div class="field field-required">
            <label for="relationship_status">Relationship Status</label>
            <select id="relationship_status" name="relationship_status" required onchange="validatePreferences()">
              <option value="">Select status</option>
              <option value="single">Single</option>
              <option value="divorced">Divorced</option>
              <option value="separated">Separated</option>
              <option value="widowed">Widowed</option>
            </select>
          </div>

          <div class="field field-required">
            <label for="children">Do you have children?</label>
            <select id="children" name="children" required onchange="validatePreferences()">
              <option value="">Select</option>
              <option value="none">No children</option>
              <option value="yes_live_with_me">Yes, live with me</option>
              <option value="yes_not_with_me">Yes, don't live with me</option>
            </select>
          </div>

          <div class="field field-required">
            <label for="want_children">Want children?</label>
            <select id="want_children" name="want_children" required onchange="validatePreferences()">
              <option value="">Select</option>
              <option value="want">Want children</option>
              <option value="dont_want">Don't want children</option>
              <option value="not_sure">Not sure</option>
              <option value="open">Open to it</option>
            </select>
          </div>

          <div class="field field-required">
            <label for="ethnicity">Ethnicity</label>
            <select id="ethnicity" name="ethnicity" required onchange="validatePreferences()">
              <option value="">Select ethnicity</option>
              <option value="asian">Asian</option>
              <option value="black">Black</option>
              <option value="caucasian">Caucasian</option>
              <option value="hispanic">Hispanic</option>
              <option value="mixed">Mixed</option>
              <option value="middle_eastern">Middle Eastern</option>
              <option value="native">Native/Indigenous</option>
              <option value="pacific_islander">Pacific Islander</option>
              <option value="prefer_not_say">Prefer not to say</option>
            </select>
          </div>

          <!-- Lifestyle Habits -->
          <div class="field field-required">
            <label for="smoking">Smoking</label>
            <select id="smoking" name="smoking" required onchange="validatePreferences()">
              <option value="">Select</option>
              <option value="non_smoker">Non-smoker</option>
              <option value="social_smoker">Social smoker</option>
              <option value="light_smoker">Light smoker</option>
              <option value="regular_smoker">Regular smoker</option>
            </select>
          </div>

          <div class="field field-required">
            <label for="drinking">Drinking</label>
            <select id="drinking" name="drinking" required onchange="validatePreferences()">
              <option value="">Select</option>
              <option value="non_drinker">Non-drinker</option>
              <option value="social_drinker">Social drinker</option>
              <option value="regular_drinker">Regular drinker</option>
            </select>
          </div>

          <!-- Intent Preference -->
          <div class="field field-required">
            <label>What Are You Looking For?</label>
            <select id="prefIntent" name="preferred_intent" required onchange="validatePreferences()">
              <option value="">Select intent</option>
              <option value="friends">New friends</option>
              <option value="casual">Casual dating</option>
              <option value="longterm">Long-term relationship</option>
              <option value="marriage">Marriage</option>
              <option value="any">Any</option>
            </select>
          </div>
        </div>

        <!-- Interests & Hobbies - AT LEAST ONE REQUIRED -->
        <div class="field field-required" style="grid-column:1/-1">
          <label>My Interests & Hobbies (select at least one)</label>
          <div class="tag-options" id="interests-container">
            <label class="tag-option"><input type="checkbox" name="my_interests" value="dining_out" onchange="validatePreferences()"><span>Dining Out</span></label>
            <label class="tag-option"><input type="checkbox" name="my_interests" value="travel" onchange="validatePreferences()"><span>Travel</span></label>
            <label class="tag-option"><input type="checkbox" name="my_interests" value="fitness" onchange="validatePreferences()"><span>Fitness</span></label>
            <label class="tag-option"><input type="checkbox" name="my_interests" value="movies" onchange="validatePreferences()"><span>Movies & Cinema</span></label>
            <label class="tag-option"><input type="checkbox" name="my_interests" value="music" onchange="validatePreferences()"><span>Live Music</span></label>
            <label class="tag-option"><input type="checkbox" name="my_interests" value="cooking" onchange="validatePreferences()"><span>Cooking</span></label>
            <label class="tag-option"><input type="checkbox" name="my_interests" value="beach" onchange="validatePreferences()"><span>Beach</span></label>
            <label class="tag-option"><input type="checkbox" name="my_interests" value="hiking" onchange="validatePreferences()"><span>Hiking & Nature</span></label>
            <label class="tag-option"><input type="checkbox" name="my_interests" value="sports" onchange="validatePreferences()"><span>Sports</span></label>
            <label class="tag-option"><input type="checkbox" name="my_interests" value="art_culture" onchange="validatePreferences()"><span>Art & Culture</span></label>
            <label class="tag-option"><input type="checkbox" name="my_interests" value="gaming" onchange="validatePreferences()"><span>Gaming</span></label>
            <label class="tag-option"><input type="checkbox" name="my_interests" value="reading" onchange="validatePreferences()"><span>Reading</span></label>
          </div>
          <div id="interests-error" class="error-message"></div>
        </div>

        <!-- Continue button -->
        <div class="save-actions">
          <div class="save-main">
            <button type="button" class="btn btn-muted" onclick="switchToTab('basic-info')">
              <span class="material-icons">arrow_back</span>
              Back to Basic Info
            </button>
            <button type="button" class="btn btn-primary" id="continue-to-profile" onclick="switchToTab('profile-content')" disabled>
              <span class="material-icons">arrow_forward</span>
              Continue to Profile & Photos
            </button>
          </div>
          <div id="preferences-errors" class="error-message"></div>
        </div>
      </section>
    </div>

    <!-- PROFILE & PHOTOS SECTION - MINIMUM REQUIREMENTS -->
    <div class="settings-section" id="profile-content-tab">
      <section class="card">
        <div class="section-header" style="display:flex;align-items:center;margin-bottom:8px">
          <h3 style="margin:0">üì∏ Profile & Photos</h3>
        </div>

        <!-- Profile Photo Section - REQUIRED -->
        <div class="field field-required">
          <label>Profile Photo (required)</label>
          <div style="display:flex;align-items:center;gap:20px;margin-bottom:10px;">
            <div class="photo-upload-trigger" onclick="addProfilePhoto()" id="profile-photo-container" style="width:120px;height:120px;">
              <div class="upload-icon">+</div>
              <div class="upload-text">
                <h4>Add Profile Photo</h4>
                <p>Click to upload</p>
              </div>
            </div>
            <button type="button" class="btn btn-muted" onclick="addProfilePhoto()">
              <span class="material-icons">upload</span> 
              Upload Photo
            </button>
          </div>
          <small class="badge-note">This will be your main profile photo</small>
          <div id="profile-photo-error" class="error-message"></div>
          <div id="profile-photo-success" class="success-message"></div>
        </div>

        <!-- Additional Photos Section - OPTIONAL -->
        <div class="field">
          <label>Additional Photos (optional)</label>
          <div class="photo-grid" id="additional-photos-container">
            <div class="photo-upload-trigger" onclick="addAdditionalPhoto()">
              <div class="upload-icon">+</div>
              <div class="upload-text">
                <h4>Add Photo</h4>
                <p>Click to upload</p>
              </div>
            </div>
          </div>
          <div class="photo-count"><span id="additional-count">0</span>/4 additional photos</div>
        </div>

        <!-- Private Photos Section - OPTIONAL -->
        <div class="field">
          <label>Private Photos (optional)</label>
          <div class="photo-grid" id="private-photos-container">
            <div class="photo-upload-trigger" onclick="addPrivatePhoto()">
              <div class="upload-icon">+</div>
              <div class="upload-text">
                <h4>Add Private Photo</h4>
                <p>Click to upload</p>
              </div>
            </div>
          </div>
          <div class="photo-count"><span id="private-count">0</span>/4 private photos</div>
          <small class="badge-note" style="color:#dc2626;margin-top:8px">‚ö†Ô∏è Private photos will only be visible to users you approve</small>
        </div>

        <!-- Text Content Fields - ALL REQUIRED -->
        <div class="grid-2" style="margin-top:20px">
          <div class="field field-required">
            <label for="location">Your Location</label>
            <input type="text" id="location" name="location" placeholder="Suburb, City - e.g. Bondi, Sydney" required
                   oninput="validateProfileContent()">
            <small class="badge-note">Be specific - this helps find matches nearby</small>
          </div>

          <div class="field field-required">
            <label>Headline</label>
            <input name="headline" placeholder="Short tagline about yourself" required
                   oninput="validateProfileContent()">
            <small class="badge-note">A catchy phrase that represents you</small>
          </div>

          <div class="field field-required" style="grid-column:1/-1">
            <label>About Me</label>
            <textarea name="about" rows="6" placeholder="Tell people about you..." required
                      oninput="validateProfileContent()"></textarea>
            <small class="badge-note">Share your story, interests, and what you're looking for</small>
          </div>
        </div>

        <!-- Final Save button -->
        <div class="save-actions">
          <div class="save-main">
            <button type="button" class="btn btn-muted" onclick="switchToTab('preferences')">
              <span class="material-icons">arrow_back</span>
              Back to Lifestyle & Compatibility
            </button>
            <button type="submit" class="btn btn-primary" id="submit-profile" disabled>
              <span class="material-icons">rocket_launch</span>
              Submit Profile for Approval
            </button>
          </div>
          <div id="profile-errors" class="error-message"></div>
        </div>
      </section>
    </div>
  </form>
</main>

<script>
// Global variables
let profilePhotoUploaded = false;
let uploadedPhotos = {
    profile: null,
    additional: [],
    private: []
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    validateBasicInfo();
});

// Tab switching with validation
function switchToTab(tabName) {
    let canSwitch = true;
    
    if (tabName === 'preferences') {
        canSwitch = validateBasicInfo(true);
    } else if (tabName === 'profile-content') {
        canSwitch = validatePreferences(true);
    }
    
    if (!canSwitch) {
        alert('Please complete all required fields before continuing.');
        return;
    }
    
    // Update progress dots
    updateProgressDots(tabName);
    
    // Update active tab button
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active', 'disabled');
        if (btn.getAttribute('data-tab') === tabName) {
            btn.classList.add('active');
        }
    });
    
    // Enable next tabs
    if (tabName === 'basic-info') {
        document.getElementById('preferences-tab-btn').classList.remove('disabled');
    } else if (tabName === 'preferences') {
        document.getElementById('profile-tab-btn').classList.remove('disabled');
    }
    
    // Show corresponding section
    document.querySelectorAll('.settings-section').forEach(section => {
        section.classList.remove('active');
    });
    document.getElementById(tabName + '-tab').classList.add('active');
}

// Progress indicator
function updateProgressDots(currentTab) {
    const dots = {
        'basic-info': 'progress-basic',
        'preferences': 'progress-preferences', 
        'profile-content': 'progress-profile'
    };
    
    Object.entries(dots).forEach(([tab, dotId]) => {
        const dot = document.getElementById(dotId);
        if (tab === currentTab) {
            dot.className = 'progress-dot active';
        } else if (
            (currentTab === 'preferences' && tab === 'basic-info') ||
            (currentTab === 'profile-content' && (tab === 'basic-info' || tab === 'preferences'))
        ) {
            dot.className = 'progress-dot completed';
        } else {
            dot.className = 'progress-dot';
        }
    });
}

// STRICT Basic Info Validation
function validateBasicInfo(showErrors = false) {
    const errors = [];
    const fields = ['username', 'age', 'my_gender', 'looking_for', 'date_of_birth'];
    let allValid = true;
    
    fields.forEach(field => {
        const element = document.getElementById(field);
        if (!element || !element.value.trim()) {
            allValid = false;
            if (showErrors) {
                element.classList.add('validation-error');
                errors.push(`${element.labels[0].textContent} is required`);
            }
        } else {
            element.classList.remove('validation-error');
        }
    });
    
    // Additional validation for age
    const ageElement = document.getElementById('age');
    if (ageElement && ageElement.value) {
        const age = parseInt(ageElement.value);
        if (age < 18 || age > 80) {
            allValid = false;
            errors.push('Age must be between 18 and 80');
            ageElement.classList.add('validation-error');
        }
    }
    
    // Username availability check
    const usernameStatus = document.getElementById('username-status');
    if (usernameStatus && usernameStatus.classList.contains('username-taken')) {
        allValid = false;
        if (showErrors) {
            errors.push('Username is already taken');
        }
    }
    
    // Enable button when all fields are valid
    const continueBtn = document.getElementById('continue-to-preferences');
    if (continueBtn) {
        continueBtn.disabled = !allValid;
    }
    
    if (showErrors && errors.length > 0) {
        document.getElementById('basic-info-errors').textContent = errors.join(', ');
    } else {
        document.getElementById('basic-info-errors').textContent = '';
    }
    
    return allValid;
}

// STRICT Preferences Validation  
function validatePreferences(showErrors = false) {
    const errors = [];
    const requiredSelects = ['body_type', 'relationship_status', 'children', 'want_children', 'ethnicity', 'smoking', 'drinking', 'prefIntent'];
    let allValid = true;
    
    // Check dropdowns
    requiredSelects.forEach(select => {
        const element = document.querySelector(`[name="${select}"]`) || document.getElementById(select);
        if (element && !element.value) {
            allValid = false;
            if (showErrors) {
                element.classList.add('validation-error');
                errors.push(`${element.labels[0].textContent} is required`);
            }
        } else if (element) {
            element.classList.remove('validation-error');
        }
    });
    
    // Check interests (at least one)
    const interests = document.querySelectorAll('input[name="my_interests"]:checked');
    if (interests.length === 0) {
        allValid = false;
        if (showErrors) {
            document.getElementById('interests-container').style.borderColor = '#dc2626';
            errors.push('Select at least one interest');
        }
    } else {
        document.getElementById('interests-container').style.borderColor = '';
    }
    
    // Enable button when all fields are valid
    const continueBtn = document.getElementById('continue-to-profile');
    if (continueBtn) {
        continueBtn.disabled = !allValid;
    }
    
    if (showErrors && errors.length > 0) {
        document.getElementById('preferences-errors').textContent = errors.join(', ');
    } else {
        document.getElementById('preferences-errors').textContent = '';
    }
    
    return allValid;
}

// STRICT Profile Content Validation
function validateProfileContent(showErrors = false) {
    const errors = [];
    const requiredFields = ['location', 'headline', 'about'];
    let allValid = true;
    
    // Check text fields
    requiredFields.forEach(field => {
        const element = document.querySelector(`[name="${field}"]`);
        if (!element.value.trim()) {
            allValid = false;
            if (showErrors) {
                element.classList.add('validation-error');
                errors.push(`${element.labels[0].textContent} is required`);
            }
        } else {
            element.classList.remove('validation-error');
        }
    });
    
    // Check profile photo
    if (!profilePhotoUploaded) {
        allValid = false;
        if (showErrors) {
            document.getElementById('profile-photo-container').style.borderColor = '#dc2626';
            errors.push('Profile photo is required');
        }
    } else {
        document.getElementById('profile-photo-container').style.borderColor = '';
    }
    
    // Enable button when all fields are valid
    const submitBtn = document.getElementById('submit-profile');
    if (submitBtn) {
        submitBtn.disabled = !allValid;
    }
    
    if (showErrors && errors.length > 0) {
        document.getElementById('profile-errors').textContent = errors.join(', ');
    } else {
        document.getElementById('profile-errors').textContent = '';
    }
    
    return allValid;
}

// Username availability check
function checkUsernameAvailability(username) {
    const statusElement = document.getElementById('username-status');
    
    if (username.length < 3) {
        statusElement.textContent = 'Username must be at least 3 characters';
        statusElement.className = 'username-status username-taken';
        validateBasicInfo();
        return;
    }
    
    statusElement.textContent = 'Checking availability...';
    statusElement.className = 'username-status username-checking';
    
    fetch(`/check-username/?username=${encodeURIComponent(username)}`)
    .then(response => {
        if (!response.ok) {
            throw new Error(`Server returned ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.available) {
            statusElement.textContent = '‚úì Username available';
            statusElement.className = 'username-status username-available';
        } else {
            statusElement.textContent = '‚úó Username already taken';
            statusElement.className = 'username-status username-taken';
        }
        validateBasicInfo();
    })
    .catch(error => {
        console.error('Error checking username:', error);
        statusElement.textContent = '‚úó Error checking username';
        statusElement.className = 'username-status username-taken';
        validateBasicInfo();
    });
}

// SIMPLE PHOTO UPLOAD FUNCTIONS
function addProfilePhoto() {
    triggerFileInput('profile');
}

function addAdditionalPhoto() {
    const additionalCount = uploadedPhotos.additional.length;
    if (additionalCount >= 4) {
        alert('Maximum 4 additional photos allowed');
        return;
    }
    triggerFileInput('additional');
}

function addPrivatePhoto() {
    const privateCount = uploadedPhotos.private.length;
    if (privateCount >= 4) {
        alert('Maximum 4 private photos allowed');
        return;
    }
    triggerFileInput('private');
}

function triggerFileInput(photoType) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = function(e) {
        if (e.target.files && e.target.files[0]) {
            uploadPhotoDirect(e.target.files[0], photoType);
        }
    };
    input.click();
}

// Photo upload function
function uploadPhotoDirect(file, photoType) {
    const statusElement = document.getElementById('profile-photo-error');
    const successElement = document.getElementById('profile-photo-success');
    
    statusElement.textContent = '';
    successElement.textContent = 'Uploading photo...';
    successElement.style.color = '#64748b';
    
    const formData = new FormData();
    formData.append('image', file);
    formData.append('image_type', photoType);

    fetch('/api/upload-profile-image/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
        },
        body: formData,
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Upload failed with status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            successElement.textContent = 'Photo uploaded successfully!';
            successElement.style.color = '#10b981';
            
            // Store photo data
            if (photoType === 'profile') {
                uploadedPhotos.profile = data;
                profilePhotoUploaded = true;
                updateProfilePhotoDisplay(data);
            } else if (photoType === 'additional') {
                uploadedPhotos.additional.push(data);
                updateAdditionalPhotoDisplay(data);
            } else if (photoType === 'private') {
                uploadedPhotos.private.push(data);
                updatePrivatePhotoDisplay(data);
            }
            
            validateProfileContent();
            
            // Clear success message after 2 seconds
            setTimeout(() => {
                successElement.textContent = '';
            }, 2000);
        } else {
            throw new Error(data.error || 'Upload failed');
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        successElement.textContent = '';
        statusElement.textContent = `Upload failed: ${error.message}`;
    });
}

// Update photo displays
function updateProfilePhotoDisplay(photoData) {
    const container = document.getElementById('profile-photo-container');
    container.innerHTML = `
        <div class="photo-item">
            <img src="${photoData.image_url}" alt="Profile photo" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">
            <button type="button" class="btn-delete" onclick="deletePhoto('${photoData.image_id}', 'profile')">√ó</button>
        </div>
    `;
}

function updateAdditionalPhotoDisplay(photoData) {
    const container = document.getElementById('additional-photos-container');
    const countElement = document.getElementById('additional-count');
    
    // Remove upload trigger if it's the first photo
    const uploadTrigger = container.querySelector('.photo-upload-trigger');
    if (uploadTrigger && uploadedPhotos.additional.length === 1) {
        uploadTrigger.remove();
    }
    
    // Add new photo
    const photoItem = document.createElement('div');
    photoItem.className = 'photo-item';
    photoItem.innerHTML = `
        <img src="${photoData.image_url}" alt="Additional photo" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">
        <button type="button" class="btn-delete" onclick="deletePhoto('${photoData.image_id}', 'additional')">√ó</button>
    `;
    container.appendChild(photoItem);
    
    // Update count
    countElement.textContent = uploadedPhotos.additional.length;
    
    // Add upload trigger back if under limit
    if (uploadedPhotos.additional.length < 4 && !container.querySelector('.photo-upload-trigger')) {
        const newUploadTrigger = document.createElement('div');
        newUploadTrigger.className = 'photo-upload-trigger';
        newUploadTrigger.onclick = addAdditionalPhoto;
        newUploadTrigger.innerHTML = `
            <div class="upload-icon">+</div>
            <div class="upload-text">
                <h4>Add Photo</h4>
                <p>Click to upload</p>
            </div>
        `;
        container.appendChild(newUploadTrigger);
    }
}

function updatePrivatePhotoDisplay(photoData) {
    const container = document.getElementById('private-photos-container');
    const countElement = document.getElementById('private-count');
    
    // Remove upload trigger if it's the first photo
    const uploadTrigger = container.querySelector('.photo-upload-trigger');
    if (uploadTrigger && uploadedPhotos.private.length === 1) {
        uploadTrigger.remove();
    }
    
    // Add new photo
    const photoItem = document.createElement('div');
    photoItem.className = 'photo-item';
    photoItem.innerHTML = `
        <img src="${photoData.image_url}" alt="Private photo" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">
        <button type="button" class="btn-delete" onclick="deletePhoto('${photoData.image_id}', 'private')">√ó</button>
    `;
    container.appendChild(photoItem);
    
    // Update count
    countElement.textContent = uploadedPhotos.private.length;
    
    // Add upload trigger back if under limit
    if (uploadedPhotos.private.length < 4 && !container.querySelector('.photo-upload-trigger')) {
        const newUploadTrigger = document.createElement('div');
        newUploadTrigger.className = 'photo-upload-trigger';
        newUploadTrigger.onclick = addPrivatePhoto;
        newUploadTrigger.innerHTML = `
            <div class="upload-icon">+</div>
            <div class="upload-text">
                <h4>Add Private Photo</h4>
                <p>Click to upload</p>
            </div>
        `;
        container.appendChild(newUploadTrigger);
    }
}

// Photo deletion function
function deletePhoto(imageId, photoType) {
    if (!confirm('Are you sure you want to delete this photo? This action cannot be undone.')) {
        return;
    }

    fetch(`/api/delete-image/${imageId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Delete failed with status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Remove from our local storage
            if (photoType === 'profile') {
                uploadedPhotos.profile = null;
                profilePhotoUploaded = false;
                resetProfilePhotoDisplay();
            } else if (photoType === 'additional') {
                uploadedPhotos.additional = uploadedPhotos.additional.filter(photo => photo.image_id != imageId);
                resetAdditionalPhotoDisplay();
            } else if (photoType === 'private') {
                uploadedPhotos.private = uploadedPhotos.private.filter(photo => photo.image_id != imageId);
                resetPrivatePhotoDisplay();
            }
            
            validateProfileContent();
        } else {
            throw new Error(data.error || 'Delete failed');
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        alert(`Delete failed: ${error.message}`);
    });
}

// Reset photo displays after deletion
function resetProfilePhotoDisplay() {
    const container = document.getElementById('profile-photo-container');
    container.innerHTML = `
        <div class="upload-icon">+</div>
        <div class="upload-text">
            <h4>Add Profile Photo</h4>
            <p>Click to upload</p>
        </div>
    `;
    container.onclick = () => addProfilePhoto();
}

function resetAdditionalPhotoDisplay() {
    const container = document.getElementById('additional-photos-container');
    const countElement = document.getElementById('additional-count');
    
    // Clear container
    container.innerHTML = '';
    
    // Add existing photos
    uploadedPhotos.additional.forEach(photo => {
        const photoItem = document.createElement('div');
        photoItem.className = 'photo-item';
        photoItem.innerHTML = `
            <img src="${photo.image_url}" alt="Additional photo" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">
            <button type="button" class="btn-delete" onclick="deletePhoto('${photo.image_id}', 'additional')">√ó</button>
        `;
        container.appendChild(photoItem);
    });
    
    // Add upload trigger if under limit
    if (uploadedPhotos.additional.length < 4) {
        const uploadTrigger = document.createElement('div');
        uploadTrigger.className = 'photo-upload-trigger';
        uploadTrigger.onclick = addAdditionalPhoto;
        uploadTrigger.innerHTML = `
            <div class="upload-icon">+</div>
            <div class="upload-text">
                <h4>Add Photo</h4>
                <p>Click to upload</p>
            </div>
        `;
        container.appendChild(uploadTrigger);
    }
    
    // Update count
    countElement.textContent = uploadedPhotos.additional.length;
}

function resetPrivatePhotoDisplay() {
    const container = document.getElementById('private-photos-container');
    const countElement = document.getElementById('private-count');
    
    // Clear container
    container.innerHTML = '';
    
    // Add existing photos
    uploadedPhotos.private.forEach(photo => {
        const photoItem = document.createElement('div');
        photoItem.className = 'photo-item';
        photoItem.innerHTML = `
            <img src="${photo.image_url}" alt="Private photo" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">
            <button type="button" class="btn-delete" onclick="deletePhoto('${photo.image_id}', 'private')">√ó</button>
        `;
        container.appendChild(photoItem);
    });
    
    // Add upload trigger if under limit
    if (uploadedPhotos.private.length < 4) {
        const uploadTrigger = document.createElement('div');
        uploadTrigger.className = 'photo-upload-trigger';
        uploadTrigger.onclick = addPrivatePhoto;
        uploadTrigger.innerHTML = `
            <div class="upload-icon">+</div>
            <div class="upload-text">
                <h4>Add Private Photo</h4>
                <p>Click to upload</p>
            </div>
        `;
        container.appendChild(uploadTrigger);
    }
    
    // Update count
    countElement.textContent = uploadedPhotos.private.length;
}

// Helper function to get CSRF token
function getCSRFToken() {
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    return csrfInput ? csrfInput.value : '';
}

// Form submission
document.getElementById('profileForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!validateBasicInfo(true) || !validatePreferences(true) || !validateProfileContent(true)) {
        alert('Please complete all required fields before submitting');
        return false;
    }
    
    // Show loading state
    const submitBtn = document.getElementById('submit-profile');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="material-icons">hourglass_empty</span> Submitting...';
    submitBtn.disabled = true;
    
    // Prepare form data
    const formData = new FormData(this);
    
    // Add photo IDs to form data
    if (uploadedPhotos.profile) {
        formData.append('profile_photo_id', uploadedPhotos.profile.image_id);
    }
    
    uploadedPhotos.additional.forEach(photo => {
        formData.append('additional_photo_ids', photo.image_id);
    });
    
    uploadedPhotos.private.forEach(photo => {
        formData.append('private_photo_ids', photo.image_id);
    });
    
    // Submit via API
    fetch('/api/create-profile/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCSRFToken(),
        },
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.error || `Submission failed with status: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showSuccessModal();
        } else {
            throw new Error(data.error || 'Profile submission failed');
        }
    })
    .catch(error => {
        console.error('Submission error:', error);
        alert('Error submitting profile: ' + error.message);
        // Reset button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// Success modal functions
function showSuccessModal() {
    document.getElementById('successModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeSuccessModal() {
    document.getElementById('successModal').style.display = 'none';
    document.body.style.overflow = '';
    // Redirect to preview gate after success
    window.location.href = "{% url 'preview_gate' %}";
}

// Logout modal functions
function openLogoutModal() {
    document.getElementById('logoutModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeLogoutModal() {
    document.getElementById('logoutModal').style.display = 'none';
    document.body.style.overflow = '';
}

// Close logout modal when clicking outside
document.getElementById('logoutModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeLogoutModal();
    }
});
</script>
{% endblock %}
